<div class="meme_details">

<div class="grid_16 alpha omega">
  <% @meme.number_of_columns = 16 %>
  <% @meme.is_alpha = true %>
  <%= render :partial => "site/partials/generic_meme", :locals => { :item => @meme.item, :meme => @meme, :ignore_title_sizing => true } %>
</div>

<div class="clear"></div>

<div class="meme">

<div class="grid_4 alpha">
  <h3>Meme Strength Over Time</h3>
  <div id="meme_<%= @meme.id %>">
    <%= render :partial => "site/partials/meme_sparkline", :locals => { :meme => @meme }%>
  </div>
  <h4 style="margin-top: 1.5em;font-size: 1.3em;"><%= @items.size %> Connected Items</h4>
  <table id="connected_items" width="100%" cellspacing="0" cellpadding="0">
    <% for item in @meme.distinct_meme_items.map{ |mi| mi.item }.sort_by{ |i| i.published_at }.reverse %>
    <tr>
      <td>
        <h3 class="title" style="font-size: 81%;"><%= link_to_item_with_tracking widow_prevention(item.title), item %></h3>
        <p class="byline"><%= render :partial => "favicon", :locals => { :item => item, :colored => true, :primary_item => @meme.item } %><%= render :partial => "byline", :locals => { :item => item } %></p>
        <p class="byline"><span class="published_at"><%= display_date(item.published_at) %> <%= display_time(item.published_at) %></span></p>
      </td>
    </tr>
    <% end %>
  </table>
</div>

<div class="grid_6">
  <h3>Tweets About '<%= @words_for_twitter_search.join(" ") %>'</h3>
  <div id="topical_tweets"><span id="loading_tweets">Loading tweets..<blink>.</blink></span></div>
  <script type="text/javascript">
  // http://search.twitter.com/search.json?q=%23haiku
  max_id = 0;
  twitter_domain = "http://search.twitter.com/search.json";
  twitter_url = twitter_domain + "?callback=?&show_user=false&q=<%= @words_for_twitter_search.join("+") %>";  
  $.getJSON(twitter_url, function(data) {
    $('#loading_tweets').hide();  
    window.data1 = data;  
    max_id = data.max_id;
    if(data.results.length > 0) {
      $.each(data.results, function(i,result) {
        display_tweet(result, false);
      });
    } else {
      $("#topical_tweets").html("<p></p>").html("Sorry there are no Tweets matching: <strong><%=h @words_for_twitter_search.join(" ") %></strong>");
    } 
  });
  $.timer(10000, function (timer) {
    console.log("getting: " + twitter_url);
    $.getJSON(twitter_url, function(data) {
      console.log("got: " + data.max_id);
      window.data2 = data;
      if(data.max_id > max_id) {
        max_id = data.max_id;
        if(data.results.length > 0) {
          $.each(data.results, function(i,result) {
            display_tweet(result, true);
          });
          twitter_url = twitter_domain + data.refresh_url + "&callback=?"; // call this url next time for only new tweets
        } 
      }
    });
  });
  </script>
</div>

<div class="grid_2 omega">
  <h3>Top Words</h3>
  <table width="100%" cellspacing="0" cellpadding="0">
    <tr>
      <th class="grid_1 alpha">Word</th>
      <th class="grid_1 omega">Count</th>
    </tr>
    <% for word in @words %>
    <tr>
      <td class="grid_1 alpha"><%= word.word %></td>
      <td class="grid_1 omega"><%= word.number_of_occurances %></td>
    </tr>
    <% end %>
  </table>
  <% have_displayed_image_title = false %>
  <% for item in @meme.distinct_meme_items.sort_by{ |mi| mi.total_cosine_similarity }.reverse.map{ |mi| mi.item }.sort_by{ |i| i.published_at }.reverse %>
    <% if item.images.size != 0 && ! item.images.first.nil? && ! item.images.first.local_src.nil? %>
    <% if have_displayed_image_title == false %>  
    <h3 style="margin-top: 1.0em;">Images</h3>
    <% have_displayed_image_title = true %>
    <% end %>
    <div class="item_image_block" style="background-image: url(<%= image_path(item.images.first.local_src) %>);">
      <%= link_to_item_with_tracking "<span>#{item.feed.title}</span>", item %>
    </div>
    <% end %>
  <% end %>
  </ul>
</div>



<div class="clear"></div>

</div>